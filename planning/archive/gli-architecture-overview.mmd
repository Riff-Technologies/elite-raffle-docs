flowchart TD
    %% External Interface (Controlled Entry Point)
    subgraph "CONTROLLED ENTRY POINT"
        API_ENTRY["ğŸ”— GLI System Interface<br/>API Gateway + Lambda<br/>Authentication & Validation<br/>Rate Limiting: 1000 req/sec"]
    end

    %% GLI-31 Certified Core System
    subgraph "GLI-31 CERTIFIED CORE RAFFLE SYSTEM"
        direction TB
        
        %% Core Processing Components
        subgraph "CORE GLI FUNCTIONS"
            direction TB
            RNG["ğŸ² Random Number Generator<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ AWS Lambda (Python 3.11)<br/>â€¢ Direct CloudHSM Integration<br/>â€¢ FIPS 140-2 Level 3<br/>â€¢ Hardware-based True RNG<br/>â€¢ 512MB Memory, 30s Timeout<br/>â€¢ Private Subnet Only<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Input: Raffle ID, Range<br/>Output: Secure Random + Seed Hash<br/>Performance: <100ms, 1000 ops/min"]
            
            DRAW["âš™ï¸ Draw Engine<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ ECS Fargate Container<br/>â€¢ 1 vCPU, 2GB Memory<br/>â€¢ S3 State Management<br/>â€¢ Auto-scaling: 1-3 instances<br/>â€¢ Atomic State Transitions<br/>â€¢ Rollback Capabilities<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>States: PENDING â†’ ACTIVE â†’ <br/>DRAWING â†’ COMPLETED"]
            
            TICKET["ğŸ« Ticket Management Core<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ ECS Fargate Container<br/>â€¢ 2 vCPU, 4GB Memory<br/>â€¢ Sequential Numbering<br/>â€¢ Batch Processing<br/>â€¢ Duplicate Prevention<br/>â€¢ Collision Detection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Validation: Checksums + Integrity<br/>Range: Pre-reserved per POS device"]
            
            WINNER["ğŸ† Winner Determination<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ AWS Lambda (Python 3.11)<br/>â€¢ 1GB Memory, 5min Timeout<br/>â€¢ Reserved Concurrency: 5<br/>â€¢ Mathematical Fairness Proof<br/>â€¢ Verifiable Random Function<br/>â€¢ Multi-tier Prize Support<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Tests: Chi-square, Kolmogorov-Smirnov<br/>Documentation: GLI Math Proof"]
        end
        
        %% Data Storage
        subgraph "GLI DATA STORAGE"
            direction TB
            CORE_DB[("ğŸ” GLI Core Database<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Aurora PostgreSQL 14.x<br/>Instance: db.r6g.large<br/>2 vCPU, 16GB RAM<br/>Multi-AZ Deployment<br/>Encrypted at Rest (KMS)<br/>SSL/TLS 1.2+ in Transit<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Tables:<br/>â€¢ raffles (draw states)<br/>â€¢ tickets (sequential numbers)<br/>â€¢ draws (RNG seeds, results)<br/>â€¢ audit_events (all actions)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Performance:<br/>8K read IOPS, 3K write IOPS<br/>Connection Pool: 20-40 per service")]
        end
        
        %% Audit & Compliance
        subgraph "GLI AUDIT & COMPLIANCE"
            direction TB
            AUDIT["ğŸ“ GLI Audit Service<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>â€¢ AWS Lambda (Python 3.11)<br/>â€¢ 256MB Memory, 30s Timeout<br/>â€¢ EventBridge Triggered<br/>â€¢ Real-time Processing<br/>â€¢ Cryptographic Signatures<br/>â€¢ Tamper Detection<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Captures ALL GLI Events:<br/>â€¢ RNG Operations<br/>â€¢ Draw State Changes<br/>â€¢ Ticket Generation<br/>â€¢ Winner Determination<br/>â€¢ Admin Actions"]
            
            LOGS[("ğŸ“š Immutable Audit Logs<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>S3 with Object Lock<br/>Tamper-Evident Storage<br/>Cryptographic Hash Chains<br/>Write-Once, Read-Many<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Retention Policy:<br/>â€¢ S3 Standard: 90 days<br/>â€¢ S3 Glacier: 1-7 years<br/>â€¢ Deep Archive: 7+ years<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>GLI Compliance Features:<br/>â€¢ Legal hold capability<br/>â€¢ Integrity verification<br/>â€¢ Time-stamped entries<br/>â€¢ Non-repudiation")]
        end
    end

    %% Hardware Security Module
    subgraph "HARDWARE SECURITY"
        HSM["ğŸ”’ CloudHSM Cluster<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>CloudHSM v2 (Single-AZ)<br/>FIPS 140-2 Level 3<br/>Hardware Key Material<br/>AES-256, RSA-2048/4096<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Key Features:<br/>â€¢ True Hardware RNG<br/>â€¢ Dedicated HSM Access<br/>â€¢ 90-day Key Rotation<br/>â€¢ Cross-region Backup<br/>â€¢ Automated Failover (4hr RTO)<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Cost Optimization:<br/>Single-AZ deployment<br/>KMS for non-RNG operations"]
    end

    %% GLI Compliance Monitoring
    subgraph "GLI COMPLIANCE MONITORING"
        direction TB
        COMPLIANCE["ğŸ“Š Compliance Dashboard<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Real-time GLI Status<br/>Automated Testing Scripts<br/>Statistical Fairness Validation<br/>Entropy Quality Monitoring<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Critical Alerts:<br/>â€¢ RNG entropy below threshold<br/>â€¢ Audit log gaps > 5 minutes<br/>â€¢ Unauthorized access attempts<br/>â€¢ Draw fairness deviation<br/>â€¢ HSM connectivity issues"]
        
        TESTING["ğŸ§ª Automated Compliance Testing<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Continuous GLI-31 Validation<br/>RNG Entropy Analysis<br/>Audit Log Integrity Checks<br/>Fairness Statistical Tests<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Test Schedule:<br/>â€¢ RNG Tests: Every operation<br/>â€¢ Fairness Tests: Daily<br/>â€¢ Integrity Checks: Hourly<br/>â€¢ Full Validation: Weekly<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Saves 20-30 hours per<br/>certification cycle"]
    end

    %% Access Control for GLI Core
    subgraph "GLI ACCESS CONTROL"
        direction TB
        ACCESS["ğŸ”‘ GLI Administrative Access<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Role-Based Access Control<br/>Multi-person Approval Required<br/>Break-glass Procedures<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>GLI-Admin Role:<br/>â€¢ Minimal personnel only<br/>â€¢ Draw system access<br/>â€¢ 4-hour emergency access max<br/>â€¢ Mandatory post-incident review<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>All Admin Actions Logged:<br/>â€¢ User ID + timestamp<br/>â€¢ Action type + parameters<br/>â€¢ Success/failure status<br/>â€¢ Immutable audit trail"]
    end

    %% Offline POS Integration Point
    subgraph "OFFLINE POS COMPLIANCE"
        direction TB
        OFFLINE["ğŸ“± Offline POS Operations<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>8-Hour Offline Capability<br/>Pre-Reserved Ticket Ranges<br/>Conflict-Free Design<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>GLI Compliance Features:<br/>â€¢ 1000 tickets pre-allocated<br/>â€¢ Sequential numbering maintained<br/>â€¢ Audit trail preserved offline<br/>â€¢ Automatic reconciliation<br/>â€¢ Range exhaustion alerts<br/>â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”<br/>Requires GLI Validation:<br/>8-hour duration approval<br/>Offline audit procedures"]
    end

    %% Data Flow Connections with Labels
    API_ENTRY -->|"Validated Requests<br/>Authentication Required"| RNG
    API_ENTRY -->|"Draw Commands<br/>Admin Authorization"| DRAW
    API_ENTRY -->|"Ticket Requests<br/>Range Validation"| TICKET
    API_ENTRY -->|"Winner Queries<br/>Results Only"| WINNER

    %% Core System Internal Flows
    RNG -->|"Entropy + Seed Hash<br/>Cryptographic Proof"| CORE_DB
    DRAW -->|"State Transitions<br/>Atomic Operations"| CORE_DB
    TICKET -->|"Sequential Numbers<br/>Batch Operations"| CORE_DB
    WINNER -->|"Results + Proof<br/>Mathematical Validation"| CORE_DB

    %% Hardware Security Integration
    RNG <-->|"Hardware RNG Calls<br/>FIPS 140-2 Level 3"| HSM

    %% Audit Trail Flows
    RNG -->|"All RNG Operations<br/>Seed + Timestamp"| AUDIT
    DRAW -->|"State Changes<br/>Admin Actions"| AUDIT
    TICKET -->|"Generation Events<br/>Range Allocations"| AUDIT
    WINNER -->|"Determination Process<br/>Algorithm Results"| AUDIT
    
    AUDIT -->|"Immutable Logging<br/>Cryptographic Signatures"| LOGS

    %% Compliance Monitoring
    RNG -.->|"Entropy Quality<br/>Performance Metrics"| COMPLIANCE
    DRAW -.->|"Operation Status<br/>State Validation"| COMPLIANCE
    TICKET -.->|"Numbering Integrity<br/>Collision Detection"| COMPLIANCE
    WINNER -.->|"Fairness Statistics<br/>Algorithm Validation"| COMPLIANCE
    AUDIT -.->|"Log Integrity<br/>Gap Detection"| COMPLIANCE

    %% Automated Testing
    CORE_DB -.->|"Data Validation<br/>Integrity Checks"| TESTING
    LOGS -.->|"Audit Verification<br/>Chain Validation"| TESTING
    HSM -.->|"Entropy Testing<br/>Key Validation"| TESTING

    %% Access Control
    ACCESS -.->|"Administrative Control<br/>RBAC Enforcement"| RNG
    ACCESS -.->|"Draw Authorization<br/>Multi-person Approval"| DRAW
    ACCESS -.->|"System Configuration<br/>Break-glass Access"| TICKET
    ACCESS -.->|"Result Verification<br/>Audit Access"| WINNER

    %% Offline POS Integration
    OFFLINE -->|"Pre-reserved Ranges<br/>Conflict Prevention"| TICKET
    OFFLINE -->|"Offline Audit Events<br/>Delayed Synchronization"| AUDIT

    %% Backup and Recovery (Implicit)
    CORE_DB -.->|"Automated Backup<br/>Cross-region Replication"| LOGS
    HSM -.->|"Key Backup<br/>Disaster Recovery"| LOGS

    %% Style Classes
    classDef gli fill:#ffebee,stroke:#d32f2f,stroke-width:3px,color:#000,font-weight:bold
    classDef security fill:#f1f8e9,stroke:#2e7d32,stroke-width:3px,color:#000,font-weight:bold
    classDef audit fill:#f3e5f5,stroke:#7b1fa2,stroke-width:3px,color:#000,font-weight:bold
    classDef database fill:#e8eaf6,stroke:#3f51b5,stroke-width:3px,color:#000,font-weight:bold
    classDef compliance fill:#fff3e0,stroke:#f57c00,stroke-width:3px,color:#000,font-weight:bold
    classDef access fill:#e0f2f1,stroke:#00796b,stroke-width:3px,color:#000,font-weight:bold
    classDef offline fill:#fce4ec,stroke:#c2185b,stroke-width:3px,color:#000,font-weight:bold

    %% Apply styles
    class RNG,DRAW,TICKET,WINNER,API_ENTRY gli
    class HSM security
    class AUDIT,LOGS audit
    class CORE_DB database
    class COMPLIANCE,TESTING compliance
    class ACCESS access
    class OFFLINE offline